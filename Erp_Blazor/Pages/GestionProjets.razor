@page "/projets"
@using Erp_Blazor.Service.States
@using Shared_Erp.Entite
@using Shared_Erp.Enums
@using Shared_Erp.Projet
@using Shared_Erp.Employe
@using Shared_Erp.Tache
@using Shared_Erp.Adresse
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Shared_Erp.TypeProjet
@using Erp_Blazor.Pages.ComposantsProjet

@inject IProjetService ProjetService
@inject ITypeProjetService TypeProjetService
@inject IEntiteService EntiteService
@inject AuthenticationStateProvider AuthStateProvider
@inject EntiteState EntiteState
@inject NavigationManager NavManager

@attribute [Authorize]
@implements IDisposable

<h3>Gestion des Projets</h3>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @ErrorMessage
        <button type="button" class="btn-close" @onclick="() => ErrorMessage = null"></button>
    </div>
}

<div class="layout-container">
    @* --- SIDEBAR LISTE PROJETS --- *@
    <div class="project-list-sidebar">
        <h5 class="text-center mb-3">Mes Projets</h5>

        @if (Projetsinternes == null && Projetsexternes == null)
        {
            <p class="text-center">Chargement...</p>
        }
        else
        {
            <p class="fw-bold text-muted small mt-2">Projets internes</p>
            @foreach (var projet in Projetsinternes)
            {
                <div class="@GetClassForProjet(projet)" @onclick="() => SelectProjet(projet)">
                    @projet.Nom
                </div>
            }

            <p class="fw-bold text-muted small mt-2">Projets externes</p>
            @foreach (var projet in Projetsexternes)
            {
                <div class="@GetClassForProjet(projet)" @onclick="() => SelectProjet(projet)">
                    @projet.Nom
                </div>
            }
        }

        <button class="btn btn-sm btn-outline-light mt-3 w-100" @onclick="CreateNewProjet">
            <i class="bi bi-plus-lg"></i> + Nouveau Projet
        </button>
    </div>

    @* --- CONTENU PRINCIPAL --- *@
    <div class="project-content-area">
        @if (SelectedProjet == null)
        {
            <div class="alert alert-info mt-4">
                Veuillez sélectionner un projet à gauche pour voir les détails.
            </div>
        }
        else
        {
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>@SelectedProjet.Nom</h2>
                <span class="badge bg-secondary">
                    @((NiveauPriorite)SelectedProjet.Priorite)
                </span>
            </div>

            <ul class="nav nav-tabs project-tabs">
                <li class="nav-item">
                    <a class="nav-link @(ActiveTab == "overview" ? "active" : "")"
                       @onclick='() => ActiveTab = "overview"' style="cursor: pointer;">Overview</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(ActiveTab == "taches" ? "active" : "")"
                       @onclick='() => ActiveTab = "taches"' style="cursor: pointer;">Tâches</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(ActiveTab == "calendrier" ? "active" : "")"
                       @onclick='() => ActiveTab = "calendrier"' style="cursor: pointer;">Calendrier</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(ActiveTab == "participants" ? "active" : "")"
                       @onclick='() => ActiveTab = "participants"' style="cursor: pointer;">Participants</a>
                </li>
            </ul>

            <div class="tab-content mt-3">
                @if (ActiveTab == "overview")
                {
                    <ProjetOverview SelectedProjet="@SelectedProjet" />
                }
                
                @if (ActiveTab == "taches")
                {
                    <ProjetTaches SelectedProjet="@SelectedProjet"
                                  IsChefDeProjet="@IsChefDeProjet"
                                  EmployeConnecteId="@EmployeConnecteId"
                                  EmployeConnecteNom="@EmployeConnecteNom"
                                  PreSelectedTache="@TacheToSelectFromParticipants"
                                  OnTacheSelectedHandled="() => TacheToSelectFromParticipants = null" />
                }

                @if (ActiveTab == "calendrier")
                {
                    <ProjetCalendrier SelectedProjet="@SelectedProjet"
                                      IsChefDeProjet="@IsChefDeProjet"
                                      EmployeConnecteId="@EmployeConnecteId"
                                      EmployeConnecteNom="@EmployeConnecteNom" />
                }

                @if (ActiveTab == "participants")
                {
                    <ProjetParticipants SelectedProjet="@SelectedProjet"
                                        OnRequestSelectTache="HandleRequestSelectTache" />
                }
            </div>
        }
    </div>
</div>

@* --- MODAL DE CRÉATION DE PROJET --- *@
@if (showcreateProjetModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <EditForm Model="@NewProjet" OnValidSubmit="SaveNewProjet">
                    <DataAnnotationsValidator />
                    <div class="modal-header">
                        <h5 class="modal-title">Créer un nouveau projet</h5>
                        <button type="button" class="btn-close" @onclick="() => showcreateProjetModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Nom du projet *</label>
                            <InputText class="form-control" @bind-Value="NewProjet.Nom" placeholder="Ex: Refonte Site Web" />
                            <ValidationMessage For="@(() => NewProjet.Nom)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputTextArea class="form-control" rows="3" @bind-Value="NewProjet.Description" placeholder="Détails du projet..." />
                            <ValidationMessage For="@(() => NewProjet.Description)" />
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date de début *</label>
                                <InputDate class="form-control" @bind-Value="NewProjet.DateDebut" />
                                <ValidationMessage For="@(() => NewProjet.DateDebut)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date de fin</label>
                                <InputDate class="form-control" @bind-Value="NewProjet.DateFin" />
                                <ValidationMessage For="@(() => NewProjet.DateFin)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Priorité</label>
                                <InputSelect class="form-select" @bind-Value="NewProjet.Priorite">
                                    @foreach (var niveau in Enum.GetValues(typeof(NiveauPriorite)))
                                    {
                                        <option value="@niveau">@niveau</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Entité Cliente</label>
                            <div class="d-flex gap-2">
                                <InputSelect class="form-select" @bind-Value="NewProjet.EntiteClienteId">
                                    <option value="">-- Sélectionner une entité --</option>
                                    @foreach (var ent in Entites)
                                    {
                                        <option value="@ent.Id">@ent.Nom</option>
                                    }
                                </InputSelect>
                                <button type="button" class="btn btn-secondary" @onclick="OpenModalEntite">+</button>
                            </div>
                            <ValidationMessage For="@(() => NewProjet.EntiteClienteId)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type de Projet</label>
                            <div class="d-flex gap-2">

                                <InputSelect class="form-select" @bind-Value="NewProjet.TypeProjetId">
                                    <option value="">-- Sélectionner un type de projet --</option>
                                    @foreach (var typ in TypesProjet)
                                    {
                                        <option value="@typ.Id">@typ.Nom</option>
                                    }
                                </InputSelect>
                                <button type="button" class="btn btn-secondary" @onclick="OpenModalTypeProjet">+</button>
                            </div>
                            <ValidationMessage For="@(() => NewProjet.TypeProjetId)" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => showcreateProjetModal = false">Annuler</button>
                        <button type="submit" class="btn btn-primary">Créer Projet</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@* --- MODAL DE CRÉATION D'ENTITÉ --- *@
@if (ShowModalCreateEntite)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px);">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content modal-content-modern">
                <EditForm Model="@NewEntite" OnValidSubmit="SaveNewEntite">
                    <DataAnnotationsValidator />
                    <div class="modal-header modal-header-modern">
                        <div>
                            <h5 class="modal-title fw-bold text-primary">
                                <i class="bi bi-building-add me-2"></i>Nouvelle Entité
                            </h5>
                            <small class="text-muted">Ajoutez un partenaire ou une entreprise cliente</small>
                        </div>
                        <button type="button" class="btn-close" @onclick="CloseModalEntite"></button>
                    </div>
                    <div class="modal-body modal-body-modern">
                        <div class="row g-3">
                            <div class="col-md-7">
                                <div class="form-floating">
                                    <InputText id="nomEntite" class="form-control" @bind-Value="NewEntite.Nom" placeholder="Nom" />
                                    <label for="nomEntite">Nom de l'entité *</label>
                                </div>
                                <ValidationMessage For="@(() => NewEntite.Nom)" class="text-danger small ms-1" />
                            </div>
                            <div class="col-md-5">
                                <div class="form-floating">
                                    <InputText id="telEntite" class="form-control" @bind-Value="NewEntite.Contact" placeholder="Tel" />
                                    <label for="telEntite">Contact</label>
                                </div>
                                <ValidationMessage For="@(() => NewEntite.Contact)" class="text-danger small ms-1" />
                            </div>
                        </div>

                        <div class="section-box mt-4">
                            <span class="section-title"><i class="bi bi-info-circle me-2"></i>Type Juridique</span>
                            <div class="d-flex align-items-center mb-3">
                                <span class="@(!NewEntite.EstEntreprise ? "fw-bold text-dark" : "text-muted") me-3">Consortium</span>
                                <div class="form-check form-switch fs-4 m-0">
                                    <InputCheckbox class="form-check-input" role="switch"
                                                   Value="NewEntite.EstEntreprise"
                                                   ValueChanged="@((bool value) => OnTypeEntiteChanged(value))"
                                                   ValueExpression="@(() => NewEntite.EstEntreprise)" />
                                </div>
                                <span class="@(NewEntite.EstEntreprise ? "fw-bold text-primary" : "text-muted") ms-3">Entreprise</span>
                            </div>

                            @if (NewEntite.EstEntreprise)
                            {
                                <div class="animate fade-in mt-3">
                                    <div class="form-floating">
                                        <InputText id="siretEntite" class="form-control" @bind-Value="NewEntite.Siret" placeholder="SIRET" />
                                        <label for="siretEntite">Numéro de SIRET</label>
                                    </div>
                                    <ValidationMessage For="@(() => NewEntite.Siret)" class="text-danger small ms-1" />
                                </div>

                                <div class="section-box">
                                    <span class="section-title"><i class="bi bi-geo-alt me-2"></i>Localisation</span>
                                    <div class="form-floating mb-3">
                                        <InputText id="rueEntite" class="form-control" @bind-Value="NewEntite.Adresse.Rue" placeholder="Rue" />
                                        <label for="rueEntite">Rue / Voie</label>
                                        <ValidationMessage For="@(() => NewEntite.Adresse.Rue)" class="text-danger small ms-1" />
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-5">
                                            <div class="form-floating">
                                                <InputText id="cpEntite" class="form-control" @bind-Value="NewEntite.Adresse.CodePostal" placeholder="CP" />
                                                <label for="cpEntite">Code Postal</label>
                                            </div>
                                            <ValidationMessage For="@(() => NewEntite.Adresse.CodePostal)" class="text-danger small ms-1" />
                                        </div>
                                        <div class="col-md-7">
                                            <div class="form-floating">
                                                <InputText id="villeEntite" class="form-control" @bind-Value="NewEntite.Adresse.Ville" placeholder="Ville" />
                                                <label for="villeEntite">Ville</label>
                                            </div>
                                            <ValidationMessage For="@(() => NewEntite.Adresse.Ville)" class="text-danger small ms-1" />
                                        </div>
                                    </div>
                                    <div class="form-floating mt-3">
                                        <InputText id="paysEntite" class="form-control" @bind-Value="NewEntite.Adresse.Pays" placeholder="Pays" />
                                        <label for="paysEntite">Pays</label>
                                        <ValidationMessage For="@(() => NewEntite.Adresse.Pays)" class="text-danger small ms-1" />
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0 pb-4 pe-4">
                        <button type="button" class="btn btn-outline-secondary px-4 rounded-pill" @onclick="CloseModalEntite">Annuler</button>
                        <button type="submit" class="btn btn-primary px-4 rounded-pill shadow-sm">
                            <i class="bi bi-check-lg me-1"></i> Créer l'entité
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}


@* Modale de création de type de projet *@
@if (ShowModalCreateTypeProjet)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px);">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content modal-content-modern">
                <EditForm Model="@NewTypeProjet" OnValidSubmit="SaveNewTypeProjet">
                    <DataAnnotationsValidator />
                    <div class="modal-header modal-header-modern">
                        <div>
                            <h5 class="modal-title fw-bold text-primary">
                                <i class="bi bi-building-add me-2"></i>Nouveau type de projet
                            </h5>
                        </div>
                        <button type="button" class="btn-close" @onclick="CloseModalTypeProjet"></button>
                    </div>
                    <div class="modal-body modal-body-modern">
                        <div class="row g-3">
                            <div class="col-md-7">
                                <div class="form-floating">
                                    <InputText id="nomType" class="form-control" @bind-Value="NewTypeProjet.Nom" placeholder="Nom" />
                                    <label for="nomType">Nom du type de projet *</label>
                                </div>
                                <ValidationMessage For="@(() => NewTypeProjet.Nom)" class="text-danger small ms-1" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0 pb-4 pe-4">
                        <button type="button" class="btn btn-outline-secondary px-4 rounded-pill" @onclick="CloseModalTypeProjet">Annuler</button>
                        <button type="submit" class="btn btn-primary px-4 rounded-pill shadow-sm">
                            <i class="bi bi-check-lg me-1"></i> Créer le type de projet
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}
@code {
    [SupplyParameterFromQuery]
    public int? ProjetId { get; set; }

    private List<ProjetDTO> Projetsinternes = new List<ProjetDTO>();
    private List<ProjetDTO> Projetsexternes = new List<ProjetDTO>();
    private List<TypeProjetDTO> TypesProjet = new List<TypeProjetDTO>();
    private List<EntiteDTO> Entites = new List<EntiteDTO>();

    private ProjetDTO? SelectedProjet;
    private string ActiveTab = "overview";
    private string? ErrorMessage;

    // Variables utilisateur
    private int EmployeConnecteId;
    private string EmployeConnecteNom = "";
    private bool IsChefDeProjet = false;
    private ClaimsPrincipal _user;

    // Gestion Modal Création Projet
    private bool showcreateProjetModal = false;
    private ProjetCreateDTO NewProjet = new ProjetCreateDTO();

    // Gestion Modal Création Entité (Appelée depuis Création Projet)
    public bool ShowModalCreateEntite = false;
    public EntiteCreateDTO? NewEntite = new EntiteCreateDTO();


    // Gestion Modal Création TypeProjet (Appelée depuis Création Projet)
    public bool ShowModalCreateTypeProjet = false;
    public TypeProjetCreateDTO? NewTypeProjet = new TypeProjetCreateDTO();


    // Communication inter-onglets (Participants -> Taches)
    private TacheDTO? TacheToSelectFromParticipants;

    protected override async Task OnInitializedAsync()
    {
        EntiteState.OnChange += HandleEntiteChanged;
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _user = authState.User;

        if (_user.Identity != null && _user.Identity.IsAuthenticated)
        {
            var userIdString = _user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(userIdString, out int userId))
            {
                EmployeConnecteId = userId;
                var prenom = _user.FindFirst("prenom")?.Value ?? "";
                var nom = _user.FindFirst("nom")?.Value ?? "";
                EmployeConnecteNom = $"{prenom} {nom}";
                IsChefDeProjet = _user.IsInRole("Chef de projet");
            }
            Entites = await EntiteService.GetAll();
        }

        if (ProjetId.HasValue)
        {
            await GetProjets(); // S'assurer que les listes sont chargées
            var projetAChercher = Projetsinternes.Concat(Projetsexternes).FirstOrDefault(p => p.Id == ProjetId.Value);
            if (projetAChercher != null)
            {
                await SelectProjet(projetAChercher);
            }
        }
        else
        {
            await GetProjets();
        }

        // Initialisation par défaut pour le formulaire
        NewProjet.DateDebut = DateTime.Now;
        NewProjet.Priorite = NiveauPriorite.Normale;
    }

    private async Task GetProjets()
    {
        ErrorMessage = null;
        try
        {
            int? id = EntiteState.SelectedEntiteId;
            if (id.HasValue)
            {
                Projetsinternes = await ProjetService.GetProjetsInternesByEntiteId(id.Value);
                Projetsexternes = await ProjetService.GetProjetsExternesByEntiteId(id.Value);
            }
            else
            {
                Projetsinternes = new List<ProjetDTO>();
                Projetsexternes = new List<ProjetDTO>();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Impossible de charger les projets : {ex.Message}";
        }
        StateHasChanged();
    }

    private async void HandleEntiteChanged()
    {
        await InvokeAsync(async () =>
        {
            await GetProjets();
            StateHasChanged();
        });
    }

    private async Task SelectProjet(ProjetDTO projet)
    {
        SelectedProjet = projet;
        ActiveTab = "overview";
    }

    private string GetClassForProjet(ProjetDTO p)
    {
        return p == SelectedProjet ? "project-item active" : "project-item";
    }

    private async Task CreateNewProjet()
    {
        ErrorMessage = null;
        NewProjet = new ProjetCreateDTO
        {
            DateDebut = DateTime.Now,
            Priorite = NiveauPriorite.Normale,
            EntiteRealisatriceId = EntiteState.SelectedEntiteId
        };

        if (TypesProjet.Count == 0)
        {
            try
            {
                TypesProjet = await TypeProjetService.GetAll();
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Erreur chargement types de projet : {ex.Message}";
            }
        }
        showcreateProjetModal = true;
    }

    private async Task SaveNewProjet()
    {
        ErrorMessage = null;
        try
        {
            var createdProjet = await ProjetService.Post(NewProjet);
            await GetProjets();
            SelectedProjet = createdProjet;
            showcreateProjetModal = false;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erreur lors de la création du projet : {ex.Message}";
        }
    }

    // --- GESTION ENTITÉ (Nécessaire ici car la modal est au niveau racine) ---

    private void OnTypeEntiteChanged(bool estEntreprise)
    {
        NewEntite.EstEntreprise = estEntreprise;
        if (estEntreprise && NewEntite.Adresse == null)
        {
            NewEntite.Adresse = new AdresseCreateDTO();
        }
    }

    public void OpenModalEntite()
    {
        NewEntite = new EntiteCreateDTO
        {
            Adresse = new AdresseCreateDTO()
        };
        ShowModalCreateEntite = true;
    }


    public void CloseModalEntite()
    {
        ShowModalCreateEntite = false;
    }

    public async Task SaveNewEntite()
    {
        ErrorMessage = null;
        if (!NewEntite.EstEntreprise)
        {
            NewEntite.Adresse = null;
        }

        try
        {
            await EntiteService.Post(NewEntite);
            ShowModalCreateEntite = false;
            Entites = await EntiteService.GetAll();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erreur lors de la création de l'entité : {ex.Message}";
            if (NewEntite.EstEntreprise && NewEntite.Adresse == null)
            {
                NewEntite.Adresse = new AdresseCreateDTO();
            }
            Console.WriteLine(ErrorMessage);
        }
    }


    public void OpenModalTypeProjet()
    {
        NewTypeProjet = new TypeProjetCreateDTO {};
        ShowModalCreateTypeProjet= true;
    }

    public void CloseModalTypeProjet()
    {
        ShowModalCreateTypeProjet = false;
    }

    public async Task SaveNewTypeProjet()
    {
        ErrorMessage = null;
        try
        {
            await TypeProjetService.Post(NewTypeProjet);
            ShowModalCreateTypeProjet= false;
            TypesProjet = await TypeProjetService.GetAll();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erreur lors de la création du type de projet : {ex.Message}";
            Console.WriteLine(ErrorMessage);
        }
    }


    // Callback pour changer d'onglet depuis le composant enfant "Participants"
    private void HandleRequestSelectTache(TacheDTO tache)
    {
        TacheToSelectFromParticipants = tache;
        ActiveTab = "taches";
        StateHasChanged();
    }
    
    public void Dispose()
    {
        EntiteState.OnChange -= HandleEntiteChanged;
    }
}